---
description: TypeORM entity and migration patterns for RS School App database models
globs: server/src/models/**/*.ts, server/src/migrations/**/*.ts
alwaysApply: false
---

# RS App TypeORM Entity Patterns

## Entity Location

All entities: `server/src/models/`
NestJS imports via: `@entities/*` alias

## Do's

### Entity Definition
- Use `@CreateDateColumn()` and `@UpdateDateColumn()` for timestamps
- Export all entities from `server/src/models/index.ts`

### Columns
- Dates: `@Column({ type: 'timestamptz' })` with `Date` type
- Nullable: `@Column({ nullable: true })` with `T | null` type
- Defaults: `@Column({ default: false })` for booleans/numbers
- JSON: `@Column({ type: 'json' })` with `Record<string, unknown>` type
- Enums: `@Column({ type: 'varchar' })` with enum type

### Relations
- Always add `@Index()` on foreign key columns
- Use `@JoinColumn({ name: 'fieldId' })` to specify FK column name
- Nullable relations: `{ nullable: true, onDelete: 'SET NULL' }`
- Keep both relation property and `fieldId` column

## Don'ts

```typescript
// ❌ String for dates
@Column()
createdAt: string;
// ✅ Date with timestamptz
@Column({ type: 'timestamptz' })
createdAt: Date;

// ❌ Nullable column without null type
@Column({ nullable: true })
description: string;
// ✅ Match nullability
@Column({ nullable: true })
description: string | null;

// ❌ Foreign key without index
@Column()
courseId: number;
// ✅ Add index for performance
@Index()
@Column()
courseId: number;

// ❌ any for JSON columns
@Column({ type: 'json' })
data: any;
// ✅ Proper typing
@Column({ type: 'json', nullable: true })
data: Record<string, unknown> | null;

// ❌ Relation without explicit join column
@ManyToOne(() => Course)
course: Course;
// ✅ Explicit join column + id field
@ManyToOne(() => Course)
@JoinColumn({ name: 'courseId' })
course: Course;
@Index()
@Column()
courseId: number;

// ❌ Add entities to common/ (deprecated)
// ✅ Add to server/src/models/

// ❌ Forget to register migration
// ✅ Import in server/src/migrations/index.ts
```